(function(){var t,n=[].slice;null==(t=window.Myna)&&(window.Myna={}),Myna.debug=!1,Myna.log=function(){var t,e,i;t=arguments.length>=1?n.call(arguments,0):[],Myna.debug&&null!=(i=window.console)&&i.log(function(){var n,i,a;for(a=[],n=0,i=t.length;i>n;n++)e=t[n],a.push(JSON.stringify(e));return a}())},Myna.error=function(){var t;throw t=arguments.length>=1?n.call(arguments,0):[]},Myna.extend=function(t,n){var e,i;for(e in n)i=n[e],t[e]||(t[e]=i);return t}}).call(this),function(){Myna.jsonp={callbacks:{},counter:0,request:function(t){var n,e,i,a,r,s,o,u,l,c,h,d,p,y,g,f;null==t&&(t={}),c=function(){if(null!=(d=t.url))return d;throw"no URL specified"}(),o=null!=(p=t.success)?p:function(){},e=null!=(y=t.error)?y:function(){},u=null!=(g=t.timeout)?g:0,n="callback"+Myna.jsonp.counter++,r=!1,Myna.jsonp.callbacks[n]=function(t){return r?void 0:(r=!0,Myna.jsonp.remove(n,elem),"problem"===t.typename?e(t):o(t))},l=""+c+"?",f=t.data;for(a in f)h=f[a],l+=""+a+"="+h+"&";return l+="callback=Myna.jsonp.callbacks."+n,s=document.createElement("script"),s.setAttribute("type","text/javascript"),s.setAttribute("async","true"),s.setAttribute("src",l),s.onload=s.onreadystatechange=function(){return Myna.jsonp.remove(n,s)},document.getElementsByTagName("head")[0].appendChild(s),u>0?(i=function(){return r?void 0:(r=!0,Myna.jsonp.remove(n,s),e({typename:"problem",subtype:500,messages:{typename:"timeout",item:"The server took longer than "+t.timeout+" ms to reply"}}))},window.setTimeout(i,u)):void 0},remove:function(t,n){var e;if(e=n.readyState,!e||"complete"===e||"loaded"===e){n.onload=null;try{return n.parentNode.removeChild(n)}finally{delete Myna.jsonp.callbacks[t]}}}}}.call(this),function(){var t,n,e,i,a,r=function(t,n){return function(){return t.apply(n,arguments)}},s={}.hasOwnProperty,o=function(t,n){function e(){this.constructor=t}for(var i in n)s.call(n,i)&&(t[i]=n[i]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t};e=function(){function t(t){null==t&&(t=null),this.next=t}return t}(),i=function(t){function n(t){this.set=r(this.set,this),this.get=r(this.get,this),this.path=r(this.path,this),n.__super__.constructor.call(this,t)}return o(n,t),n.prototype.path=function(){return this.next.path().substring(1)},n.prototype.get=function(t){return this.next.get(t)},n.prototype.set=function(t,n){return this.next.set(t,n)},n}(e),t=function(t){function n(t,e){this.set=r(this.set,this),this.get=r(this.get,this),this.path=r(this.path,this),n.__super__.constructor.call(this,t),this.name=e}return o(n,t),n.prototype.path=function(){return"."+this.name+this.next.path()},n.prototype.get=function(t){return this.next.get(null!=t?t[this.name]:void 0)},n.prototype.set=function(t,n){var e,i,a;e={};for(i in t)a=t[i],e[i]=a;return e[this.name]=this.next.set(e[this.name],n),e},n}(e),n=function(t){function n(){n.__super__.constructor.call(this,null)}return o(n,t),n.prototype.path=function(){return""},n.prototype.get=function(t){return t},n.prototype.set=function(t,n){return n},n}(e),a=new n,Myna.Settings=function(){function n(t){null==t&&(t={}),this.toJson=r(this.toJson,this),this.parse=r(this.parse,this),this.set=r(this.set,this),this.get=r(this.get,this),this.data={},this.set(t)}return n.prototype.get=function(t,n){var e,i;return null==n&&(n=null),e=null!=(i=this.parse(t).get(this.data))?i:n,Myna.log("Myna.Settings.get",t,e),e},n.prototype.set=function(){var t,n,e;switch(arguments.length){case 2:t=arguments[0],n=arguments[1],Myna.log("Myna.Settings.set",t,n),this.data=this.parse(t).set(this.data,n);break;case 1:e=arguments[0];for(t in e)n=e[t],Myna.log("Myna.Settings.set",t,n),this.data=this.parse(t).set(this.data,n);break;default:throw["wrong number of arguments",arguments]}return this},n.prototype.parse=function(n){var e,r,s,o;for(e=a,o=n.split("."),s=o.length-1;s>=0;s+=-1)r=o[s],e=new t(e,r);return new i(e)},n.prototype.toJson=function(){return this.data},n}(),Myna.cache=new Myna.Settings}.call(this),function(){var t,n,e,i,a,r,s,o,u,l;null==(l=Myna.cache)&&(Myna.cache={}),Myna.cache.localStorageSupported=function(){try{return localStorage.setItem("modernizer","modernizer"),localStorage.removeItem("modernizer"),!0}catch(t){return e=t,!1}}(),Myna.cache.localStorageEnabled=!0,a=function(t){var n;if(n=window.localStorage.getItem("myna-"+t),null==n)return null;try{return JSON.parse(n)}catch(i){return e=i,null}},u=function(t,n){null!=n?window.localStorage.setItem("myna-"+t,JSON.stringify(n)):window.localStorage.removeItem("myna-"+t)},s=function(t){window.localStorage.removeItem("myna-"+t)},n=function(t){return encodeURIComponent(JSON.stringify(t))},t=function(t){return 0===t.indexOf('"')?JSON.parse(t.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\")):JSON.parse(t),JSON.parse(decodeURIComponent(t.replace(/\+/g," ")))},o=function(t,e,i){var a,r,s,o;null==i&&(i=365),o="myna-"+t+"="+n(e),r=i?(a=new Date,a.setTime(a.getTime()+1e3*60*60*24*i),"; expires="+a.toGMTString()):"",s="; path=/",document.cookie=""+o+r+s},i=function(n){var e,i,a,r,s,o,u,l;for(s="myna-"+n+"=",r=function(t){var n;return n=t.indexOf(s),n>=0&&t.substring(0,n).match("^\\s*$")},i=function(t){var n;return n=t.indexOf(s),t.substring(n+s.length,t.length)},a=document.cookie.split(";"),u=0,l=a.length;l>u;u++)if(e=a[u],r(e)&&null!=(o=i(e)))return t(o);return null},r=function(t){o(t,"",-1)},Myna.cache.load=function(t){return Myna.cache.localStorageSupported&&Myna.cache.localStorageEnabled?a(t):i(t)},Myna.cache.save=function(t,n){Myna.cache.localStorageSupported&&Myna.cache.localStorageEnabled?u(t,n):o(t,n)},Myna.cache.remove=function(t){Myna.cache.localStorageSupported&&Myna.cache.localStorageEnabled?s(t):r(t)}}.call(this),function(){Myna.Variant=function(){function t(t,n){var e,i;this.id=t,null==n&&(n={}),this.settings=new Myna.Settings(null!=(e=n.settings)?e:{}),this.weight=function(){if(null!=(i=n.weight))return i;throw"no weight provided"}(),this.views=0,this.reward=0}return t}()}.call(this),function(){var t,n=function(t,n){return function(){return t.apply(n,arguments)}},e={}.hasOwnProperty,i=function(t,n){function i(){this.constructor=t}for(var a in n)e.call(n,a)&&(t[a]=n[a]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Myna.BaseExperiment=function(){function t(t){var e,i,a,r,s,o,u,l,c;null==t&&(t={}),this.save=n(this.save,this),this.load=n(this.load,this),this.loadAndSave=n(this.loadAndSave,this),this.enqueueReward=n(this.enqueueReward,this),this.enqueueView=n(this.enqueueView,this),this.enqueueEvent=n(this.enqueueEvent,this),this.clearQueuedEvents=n(this.clearQueuedEvents,this),this.loadQueuedEvents=n(this.loadQueuedEvents,this),this.clearVariant=n(this.clearVariant,this),this.saveVariant=n(this.saveVariant,this),this.loadVariant=n(this.loadVariant,this),this.clearLastReward=n(this.clearLastReward,this),this.saveLastReward=n(this.saveLastReward,this),this.loadLastReward=n(this.loadLastReward,this),this.clearLastSuggestion=n(this.clearLastSuggestion,this),this.saveLastSuggestion=n(this.saveLastSuggestion,this),this.loadLastSuggestion=n(this.loadLastSuggestion,this),this.callback=n(this.callback,this),this.randomVariant=n(this.randomVariant,this),this.totalWeight=n(this.totalWeight,this),this.rewardVariant=n(this.rewardVariant,this),this.reward=n(this.reward,this),this.view=n(this.view,this),this.suggest=n(this.suggest,this),Myna.log("Myna.BaseExperiment.constructor",t),this.uuid=null!=(r=t.uuid)?r:Myna.error("Myna.Experiment.constructor",this.id,"no UUID in options",t),this.id=null!=(s=t.id)?s:Myna.error("Myna.Experiment.constructor",this.id,"no ID in options",t),this.callbacks=null!=(o=t.callbacks)?o:{},this.settings=new Myna.Settings(null!=(u=t.settings)?u:{}),this.variants={},c=null!=(l=t.variants)?l:{};for(i in c)e=c[i],a=new Myna.Variant(i,e),this.variants[i]=a}return t.prototype.suggest=function(t,n){var e,i,a;null==t&&(t=function(){}),null==n&&(n=function(){});try{if(Myna.log("Myna.BaseExperiment.suggest",this.id),a=this.randomVariant(),this.callback("beforeSuggest").call(this,a)===!1)return;return e=this.view(a.id,t,n),this.callback("afterSuggest").call(this,a),e}catch(r){return i=r,this.error(i)}},t.prototype.view=function(t,n,e){var i,a,r;null==n&&(n=function(){}),null==e&&(e=function(){});try{if(Myna.log("Myna.BaseExperiment.view",this.id,t),r=this.variants[t],this.callback("beforeView").call(this,r)===!1)return;return this.saveLastSuggestion(r),this.clearLastReward(),this.enqueueView(r),i=n(r),this.callback("afterView").call(this,r),i}catch(s){return a=s,e(a)}},t.prototype.reward=function(t,n,e){var i,a,r;null==t&&(t=1),null==n&&(n=function(){}),null==e&&(e=function(){});try{if(Myna.log("Myna.BaseExperiment.reward",this.id,t),r=this.loadLastSuggestion(),null!=r){if(this.callback("beforeReward").call(this,r,t)===!1)return;return i=this.rewardVariant(r,t,n,e),this.callback("afterReward").call(this,r,t)}return e()}catch(s){return a=s,e(a)}},t.prototype.rewardVariant=function(t,n,e,i){var a,r;null==n&&(n=1),null==e&&(e=function(){}),null==i&&(i=function(){});try{return Myna.log("Myna.BaseExperiment.rewardVariant",this.id,t.id,n),r=this.loadLastReward(),Myna.log(" - rewarded",r),null!=r?i():(this.clearLastSuggestion(),this.saveLastReward(t),this.enqueueReward(t,n),e(t))}catch(s){return a=s,i(a)}},t.prototype.totalWeight=function(){var t,n,e,i;t=0,i=this.variants;for(n in i)e=i[n],t+=e.weight;return t},t.prototype.randomVariant=function(){var t,n,e,i,a;Myna.log("Myna.BaseExperiment.randomVariant",this.id),e=this.totalWeight(),n=Math.random()*e,a=this.variants;for(t in a)if(i=a[t],e-=i.weight,n>=e)return Myna.log("Myna.BaseExperiment.randomVariant",this.id,i.id),i;return Myna.log("Myna.BaseExperiment.randomVariant",this.id,null),null},t.prototype.callback=function(t){var n;return n=this.callbacks[t],Myna.log("Myna.BaseExperiment.callback",this.id,t,n),null!=n?n:function(){}},t.prototype.loadLastSuggestion=function(){return this.loadVariant("lastSuggestion")},t.prototype.saveLastSuggestion=function(t){return this.saveVariant("lastSuggestion",t),this.clearVariant("lastReward")},t.prototype.clearLastSuggestion=function(){return this.clearVariant("lastSuggestion")},t.prototype.loadLastReward=function(){return this.loadVariant("lastReward")},t.prototype.saveLastReward=function(t){return this.saveVariant("lastReward",t)},t.prototype.clearLastReward=function(){return this.clearVariant("lastReward")},t.prototype.loadVariant=function(t){var n,e;return n=null!=(e=this.load())?e[t]:void 0,Myna.log("Myna.BaseExperiment.loadVariant",this.id,t,n),null!=n?this.variants[n]:null},t.prototype.saveVariant=function(t,n){return this.loadAndSave(function(e){return Myna.log("Myna.BaseExperiment.saveVariant",this.id,t,n,e),null!=n?e[t]=n.id:delete e[t],e})},t.prototype.clearVariant=function(t){return this.saveVariant(t,null)},t.prototype.loadQueuedEvents=function(){var t,n;return t=null!=(n=this.load().queuedEvents)?n:[],Myna.log("Myna.BaseExperiment.loadQueuedEvents",this.id,t),t},t.prototype.clearQueuedEvents=function(){return Myna.log("Myna.BaseExperiment.clearQueuedEvents",this.id),this.loadAndSave(function(t){return delete t.queuedEvents,t})},t.prototype.enqueueEvent=function(t){return Myna.log("Myna.BaseExperiment.enqueueEvent",this.id,t),this.loadAndSave(function(n){return null!=n.queuedEvents?n.queuedEvents.push(t):n.queuedEvents=[t],n})},t.prototype.enqueueView=function(t){return Myna.log("Myna.BaseExperiment.enqueueView",this.id,t),this.enqueueEvent({typename:"view",variant:t.id,timestamp:(new Date).getTime()})},t.prototype.enqueueReward=function(t,n){return Myna.log("Myna.BaseExperiment.enqueueReward",this.id,t,n),this.enqueueEvent({typename:"reward",variant:t.id,amount:n,timestamp:(new Date).getTime()})},t.prototype.loadAndSave=function(t){var n;return this.save(t(null!=(n=this.load())?n:{}))},t.prototype.load=function(){return Myna.cache.load(this.uuid)},t.prototype.save=function(t){return Myna.cache.save(this.uuid,t)},t}(),Myna.Experiment=function(e){function a(){return this.clearStickyReward=n(this.clearStickyReward,this),this.saveStickyReward=n(this.saveStickyReward,this),this.loadStickyReward=n(this.loadStickyReward,this),this.clearStickySuggestion=n(this.clearStickySuggestion,this),this.saveStickySuggestion=n(this.saveStickySuggestion,this),this.loadStickySuggestion=n(this.loadStickySuggestion,this),this.unstick=n(this.unstick,this),this.sticky=n(this.sticky,this),this.reward=n(this.reward,this),this.suggest=n(this.suggest,this),t=a.__super__.constructor.apply(this,arguments)}return i(a,e),a.prototype.suggest=function(t,n){var e,i,a,r,s;null==t&&(t=function(){}),null==n&&(n=function(){});try{if(Myna.log("Myna.Experiment.suggest",this.id),a=this.sticky(),a?(r=this.loadStickySuggestion(),s=null!=r?r:this.randomVariant()):(r=null,s=this.randomVariant()),Myna.log(" - suggest",r,s),this.callback("beforeSuggest").call(this,s,!!r)===!1)return;if(Myna.log(" - suggest","continuing"),null!=r)e=t(r);else{if(null==s)return n(),void 0;a&&this.saveStickySuggestion(s),e=this.view(s.id,t,n)}return Myna.log(" - suggest","continued"),this.callback("afterSuggest").call(this,s,!!r),e}catch(o){return i=o,n(i)}},a.prototype.reward=function(t,n,e){var i,a,r,s,o;null==t&&(t=1),null==n&&(n=function(){}),null==e&&(e=function(){});try{if(Myna.log("Myna.Experiment.reward",this.id,t),s=this.sticky(),s?(r=this.loadStickyReward(),o=null!=r?r:this.loadLastSuggestion()):(r=null,o=this.loadLastSuggestion()),Myna.log(" - reward",r,o,this.callback("beforeReward")),this.callback("beforeReward").call(this,o,!!r)===!1)return;if(Myna.log(" - reward","continuing"),null!=r)i=n();else{if(null==o)return e(),void 0;s&&this.saveStickyReward(o),i=this.rewardVariant(o,t,n,e)}return Myna.log(" - reward","continued"),this.callback("afterReward").call(this,o,!!r),i}catch(u){return a=u,e(a)}},a.prototype.sticky=function(){var t;return t=!!this.settings.get("myna.sticky",!0),Myna.log("Myna.Experiment.sticky",this.id,t),t},a.prototype.unstick=function(){return Myna.log("Myna.Experiment.unstick",this.id),this.clearLastSuggestion(),this.clearLastReward(),this.clearStickySuggestion()},a.prototype.loadStickySuggestion=function(){return this.loadVariant("stickySuggestion")},a.prototype.saveStickySuggestion=function(t){return this.saveVariant("stickySuggestion",t),this.clearVariant("stickyReward")},a.prototype.clearStickySuggestion=function(){return this.clearVariant("stickySuggestion"),this.clearVariant("stickyReward")},a.prototype.loadStickyReward=function(){return this.loadVariant("stickyReward")},a.prototype.saveStickyReward=function(t){return this.saveVariant("stickyReward",t)},a.prototype.clearStickyReward=function(){return this.clearVariant("stickyReward")},a}(Myna.BaseExperiment)}.call(this),function(){var t=function(t,n){return function(){return t.apply(n,arguments)}};Myna.Client=function(){function n(n){var e,i,a,r,s,o,u,l;for(null==n&&(n={}),this.reward=t(this.reward,this),this.view=t(this.view,this),this.suggest=t(this.suggest,this),this.apiRoot=null!=(s=n.apiRoot)?s:"//api.mynaweb.com",this.apiKey=null!=(o=n.apiKey)?o:Myna.error("Myna.Client.constructor","no apiKey in options",n),this.experiments={},l=null!=(u=n.experiments)?u:[],a=0,r=l.length;r>a;a++)i=l[a],e=new Myna.Experiment(i),this.experiments[e.id]=e}return n.prototype.suggest=function(t,n,e){return null==n&&(n=function(){}),null==e&&(e=function(){}),this.experiments[t].suggest(n,e)},n.prototype.view=function(t,n,e,i){return null==e&&(e=function(){}),null==i&&(i=function(){}),this.experiments[t].view(n,e,i)},n.prototype.reward=function(t,n,e,i){return null==n&&(n=1),null==e&&(e=function(){}),null==i&&(i=function(){}),this.experiments[t].reward(n,e,i)},n}()}.call(this),function(){}.call(this);