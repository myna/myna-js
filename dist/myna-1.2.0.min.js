/*! myna - v1.2.0 - 2012-09-12
* http://mynaweb.com/
* Copyright (c) 2012 Noel Welsh; Licensed BSD 2-Clause */
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h=function(e,t){return function(){return e.apply(t,arguments)}},p=[].slice;window.Myna=window.Myna!=null?window.Myna:{},s={SILENT:0,ERROR:1,WARN:2,INFO:3,DEBUG:4},i=function(){function e(e){this.loglevel=e}return e.prototype.log=function(e,t){if(window.console&&this.loglevel>=e)return window.console.log(t)},e}(),window.Myna.LogLevel=s,u=function(e,t){var n,r;for(n in t)r=t[n],e[n]||(e[n]=r);return e},e=function(){function e(e){var t;t="https:"===document.location.protocol?"https":"http",this.cookieLifespan=365,this.cookieName="myna"+e,this.timeout=400,this.baseurl=""+t+"://api.mynaweb.com",this.loglevel=s.ERROR,this.rewardSuccess=function(e){return void 0},this.error=function(e){return void 0}}return e.prototype.extend=function(e){return u(u({},e),this)},e}(),t={create:function(e,t,n){var r,i;return i=n?(r=new Date,r.setTime(r.getTime()+n*24*60*60*1e3),"; expires="+r.toGMTString()):"",document.cookie=""+e+"="+(t+i)+"; path=/"},read:function(e){var t,n,r,i,s,o,u,a;o=e+"=",s=function(e){var t;return t=e.indexOf(o),t>=0&&e.substring(0,t).match("^\\s*$")},n=function(e){var t;return t=e.indexOf(o),e.substring(t+o.length,e.length)},r=document.cookie.split(";");for(u=0,a=r.length;u<a;u++)t=r[u],s(t)&&(i=n(t));return i},erase:function(e){return t.create(e,"",-1)}},window.Myna.callbacks=[],r={callbackCounter:0,removeCallback:function(e){if(!this.readyState||this.readyState==="complete"||this.readyState==="loaded"){this.onload=null;try{return this.parentNode.removeChild(this)}catch(t){}finally{window.Myna.callbacks[e]=null}}},doJsonP:function(e){var t,n,i,s,o,u,a;s=!1,t="callback"+r.callbackCounter++,window.Myna.callbacks[t]=function(t){if(!s)return s=!0,e.success.apply(this,arguments)},o=e.url+"?",a=e.data;for(i in a)u=a[i],o+=""+i+"="+u+"&";return o+="callback=window.Myna.callbacks."+t,e.timeout>0&&window.setTimeout(function(){if(!s)return s=!0,r.removeCallback.call(n,t),e.error({typename:"problem",subtype:500,messages:[{typename:"timeout",item:"The server took longer than "+e.timeout+" ms to reply"}]})},e.timeout),n=document.createElement("script"),n.setAttribute("type","text/javascript"),n.setAttribute("async","true"),n.onload=n.onreadystatechange=function(){return r.removeCallback.call(n,t)},n.setAttribute("src",o),document.getElementsByTagName("head")[0].appendChild(n)}},n=function(){function n(t,n){this.uuid=t,n==null&&(n={}),this.recallOrSuggest=h(this.recallOrSuggest,this),this.forget=h(this.forget,this),this.recall=h(this.recall,this),this.suggest=h(this.suggest,this),this.config=(new e(this.uuid)).extend(n),this.logger=new i(this.config.loglevel)}return n.prototype.suggest=function(e,t){var n,i,a,f,l=this;return t==null&&(t=this.config.error),n=function(e){var t,n,r,i,s;i=Myna.onsuggest,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t(l,e));return s},f=function(t){var r;return l.logger.log(s.DEBUG,"Experiment.suggest successWrapper called"),l.logger.log(s.DEBUG,t),t.typename==="suggestion"?(l.logger.log(s.INFO,"Myna suggested "+t.choice),l.logger.log(s.DEBUG,"Response token is "+t.token),r=new o(l,t.choice,t.token),n(r),e?e(r):l.logger.log(s.WARN,"You should pass a success function to Experiment.suggest. See the docs for details.")):t.typename==="problem"?(l.logger.log(s.ERROR,"Experiment.suggest returned an API error: "+t.subtype+" "+t.messages),i(t)):(l.logger.log(s.ERROR,"Experiment.suggest did something unexpected"),l.logger.log(s.ERROR,t),i({typename:"problem",subtype:400,messages:[{typename:"unexpected",item:t}]}))},i=function(e){l.logger.log(s.ERROR,"Experiment.suggest errorWrapper called"),l.logger.log(s.ERROR,e),n(e);if(t)return t(e)},a={url:this.config.baseurl+("/v1/experiment/"+this.uuid+"/suggest"),data:{},success:f,error:i},r.doJsonP(u(a,this.config))},n.prototype.recall=function(){var e,n,r,i;return n=t.read(this.config.cookieName),n?(r=n.indexOf(":"),r>=0?(i=n.substring(0,r),e=n.substring(r+1,n.length),new o(this,e,i)):void 0):void 0},n.prototype.forget=function(){return t.erase(this.config.cookieName)},n.prototype.recallOrSuggest=function(e,t){var n;return t==null&&(t=this.config.error),n=this.recall(),n?e(n):this.suggest(e,t)},n}(),window.Myna.Experiment=n,o=function(){function e(e,t,n){this.experiment=e,this.choice=t,this.token=n}return e.prototype.reward=function(e,t,n){var i,o,a,f,l,c=this;return e==null&&(e=1),t==null&&(t=this.experiment.config.rewardSuccess),n==null&&(n=this.experiment.config.error),o=function(t){var n,r,i,s,o;s=Myna.onreward,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(n(c,e,t));return o},i={token:this.token,amount:e},l=function(e){return o(e),t(e)},a=function(e){c.experiment.logger.log(s.ERROR,"Suggestion.reward errorWrapper called"),c.experiment.logger.log(s.ERROR,e),o(e);if(n)return n(e)},f={url:this.experiment.config.baseurl+("/v1/experiment/"+this.experiment.uuid+"/reward"),data:i,success:l,error:a},r.doJsonP(u(f,this.experiment.config))},e.prototype.remember=function(){return t.create(this.experiment.config.cookieName,""+this.token+":"+this.choice,this.experiment.config.cookieLifespan)},e.prototype.rewardOnClick=function(e,t,n){var r,i,s=this;return n==null&&(n=1),i=function(){return window.location=t},r=function(e){return e||(e=window.event),e.stopPropagation&&e.stopPropagation(),e.returnValue&&(e.returnValue=!1),s.reward(n,i,i),!1},e.onclick=r},e}(),u(window.Myna,{onload:[],onsuggest:[],onreward:[]}),window.Myna.onload.push=function(){var e,t,n,r,i;e=1<=arguments.length?p.call(arguments,0):[],i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(t());return i},c=window.Myna.onload;for(f=0,l=c.length;f<l;f++)a=c[f],a()}).call(this);