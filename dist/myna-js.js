/*! myna-js - v0.1 - 2012-07-02
* http://mynaweb.com/
* Copyright (c) 2012 Noel Welsh; Licensed BSD 2-Clause */

// Generated by CoffeeScript 1.3.3

/*
 Myna Javascript Client
 Copyright Untyped 2012
*/


(function() {
  var Config, Cookie, Experiment, JsonP, Log, LogLevel, Suggestion, extend;

  window.Myna = {};

  LogLevel = {
    SILENT: 0,
    ERROR: 1,
    WARN: 2,
    INFO: 3,
    DEBUG: 4
  };

  Log = (function() {

    function Log(loglevel) {
      this.loglevel = loglevel;
    }

    Log.prototype.log = function(level, message) {
      if (window.console && this.loglevel >= level) {
        return window.console.log(message);
      }
    };

    return Log;

  })();

  extend = function(dest, src) {
    var key, value;
    for (key in src) {
      value = src[key];
      if (!dest[key]) {
        dest[key] = value;
      }
    }
    return dest;
  };

  Config = (function() {

    function Config(uuid) {
      this.cookieLifespan = 365;
      this.cookieName = "myna" + uuid;
      this.timeout = 1000;
      this.baseurl = "http://api.mynaweb.com";
      this.loglevel = LogLevel.ERROR;
      this.rewardSuccess = function(ok) {
        return void 0;
      };
      this.error = function(problem) {
        return void 0;
      };
    }

    Config.prototype.extend = function(options) {
      return extend(extend({}, this), options);
    };

    return Config;

  })();

  Cookie = {
    create: function(name, value, days) {
      var date, expires;
      expires = days ? (date = new Date(), date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000)), "; expires=" + date.toGMTString()) : "";
      return document.cookie = "" + name + "=" + (value + expires) + "; path=/";
    },
    read: function(name) {
      var cookie, cookieValue, cookies, found, isNameEQCookie, nameEQ, _i, _len;
      nameEQ = name + "=";
      isNameEQCookie = function(cookie) {
        var i;
        i = cookie.indexOf(nameEQ);
        return i >= 0 && cookie.substring(0, i).match('^\\s*$');
      };
      cookieValue = function(cookie) {
        var i;
        i = cookie.indexOf(nameEQ);
        return cookie.substring(i + nameEQ.length, cookie.length);
      };
      cookies = document.cookie.split(';');
      for (_i = 0, _len = cookies.length; _i < _len; _i++) {
        cookie = cookies[_i];
        if (isNameEQCookie(cookie)) {
          found = cookieValue(cookie);
        }
      }
      return found;
    },
    erase: function(name) {
      return Cookie.create(name, "", -1);
    }
  };

  window.myna = {
    callbacks: []
  };

  JsonP = {
    callbackCounter: 0,
    removeCallback: function(callbackName) {
      if (this.readyState && this.readyState !== "complete" && this.readyState !== "loaded") {

      } else {
        this.onload = null;
        try {
          return this.parentNode.removeChild(this);
        } catch (e) {

        } finally {
          window.myna.callbacks[callbackName] = null;
        }
      }
    },
    doJsonP: function(options) {
      var callbackName, elem, key, returned, url, value, _ref;
      returned = false;
      callbackName = "callback" + (JsonP.callbackCounter++);
      window.myna.callbacks[callbackName] = function(args) {
        if (!returned) {
          returned = true;
          return options.success.apply(this, arguments);
        }
      };
      url = options.url + "?";
      _ref = options.data;
      for (key in _ref) {
        value = _ref[key];
        url += "" + key + "=" + value + "&";
      }
      url += "callback=window.myna.callbacks." + callbackName;
      if (options.timeout > 0) {
        window.setTimeout(function() {
          if (!returned) {
            returned = true;
            JsonP.removeCallback.call(elem, callbackName);
            return options.error({
              typename: 'problem',
              subtype: 500,
              messages: [
                {
                  typename: "timeout",
                  item: "The server took longer than " + options.timeout + " ms to reply"
                }
              ]
            });
          }
        }, options.timeout);
      }
      elem = document.createElement("script");
      elem.setAttribute("type", "text/javascript");
      elem.setAttribute("async", "true");
      elem.onload = elem.onreadystatechange = function() {
        return JsonP.removeCallback.call(elem, callbackName);
      };
      elem.setAttribute("src", url);
      return document.getElementsByTagName("head")[0].appendChild(elem);
    }
  };

  Experiment = (function() {

    function Experiment(uuid, options) {
      this.uuid = uuid;
      if (options == null) {
        options = {};
      }
      this.config = new Config(this.uuid).extend(options);
      this.logger = new Log(this.config.loglevel);
    }

    Experiment.prototype.suggest = function(success, error) {
      var errorWrapper, successWrapper,
        _this = this;
      if (error == null) {
        error = this.config.error;
      }
      successWrapper = function(data) {
        var suggestion;
        _this.logger.log(LogLevel.DEBUG, "Experiment.suggest successWrapper called");
        _this.logger.log(LogLevel.DEBUG, data);
        if (data.typename === "suggestion") {
          _this.logger.log(LogLevel.INFO, "Myna suggested " + data.choice);
          _this.logger.log(LogLevel.DEBUG, "Response token is " + data.token);
          suggestion = new Suggestion(_this, data.choice, data.token);
          if (success) {
            return success(suggestion);
          } else {
            return _this.logger.log(LogLevel.WARN, "You should pass a success function to Experiment.suggest. See the docs for details.");
          }
        } else if (data.typename === "problem") {
          _this.logger.log(LogLevel.ERROR, "Experiment.suggest returned an API error: " + data.subtype + " " + data.messages);
          if (error) {
            return error(data);
          }
        } else {
          _this.logger.log(LogLevel.ERROR, "Experiment.suggest did something unexpected");
          _this.logger.log(LogLevel.ERROR, data);
          if (error) {
            return error({
              typename: 'problem',
              subtype: 400,
              messages: [
                {
                  typename: "unexpected",
                  item: data
                }
              ]
            });
          }
        }
      };
      errorWrapper = function(data) {
        _this.logger.log(LogLevel.DEBUG, "Experiment.suggest errorWrapper called");
        _this.logger.log(LogLevel.ERROR, data);
        _this.logger.log(LogLevel.ERROR, "Experiment.suggest failed: error " + data.messages);
        if (error) {
          return error(data);
        }
      };
      return JsonP.doJsonP({
        url: this.config.baseurl + ("/v1/experiment/" + this.uuid + "/suggest"),
        data: {},
        success: successWrapper,
        error: errorWrapper
      });
    };

    Experiment.prototype.recall = function() {
      var choice, cookie, i, token;
      cookie = Cookie.read(this.config.cookieName);
      if (cookie) {
        i = cookie.indexOf(':');
        if (i >= 0) {
          token = cookie.substring(0, i);
          choice = cookie.substring(i + 1, cookie.length);
          return new Suggestion(this, choice, token);
        } else {
          return void 0;
        }
      } else {
        return void 0;
      }
    };

    Experiment.prototype.forget = function() {
      return Cookie.erase(this.config.cookieName);
    };

    return Experiment;

  })();

  window.Myna.Experiment = Experiment;

  Suggestion = (function() {

    function Suggestion(experiment, choice, token) {
      this.experiment = experiment;
      this.choice = choice;
      this.token = token;
    }

    Suggestion.prototype.reward = function(amount, success, error) {
      var data;
      if (amount == null) {
        amount = 1.0;
      }
      if (success == null) {
        success = this.experiment.config.rewardSuccess;
      }
      if (error == null) {
        error = this.experiment.config.error;
      }
      data = {
        token: this.token,
        amount: amount
      };
      return JsonP.doJsonP({
        url: this.experiment.config.baseurl + ("/v1/experiment/" + this.experiment.uuid + "/reward"),
        data: data,
        success: success,
        error: error
      });
    };

    Suggestion.prototype.remember = function() {
      return Cookie.create(this.experiment.config.cookieName, "" + this.token + ":" + this.choice, this.experiment.config.cookieLifespan);
    };

    return Suggestion;

  })();

}).call(this);
