/*! myna - v1.1.0 - 2012-07-26
* http://mynaweb.com/
* Copyright (c) 2012 Noel Welsh; Licensed BSD 2-Clause */
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=[].slice;window.Myna=window.Myna!=null?window.Myna:{},f={SILENT:0,ERROR:1,WARN:2,INFO:3,DEBUG:4},e=function(){function a(a){this.loglevel=a}return a.prototype.log=function(a,b){if(window.console&&this.loglevel>=a)return window.console.log(b)},a}(),window.Myna.LogLevel=f,h=function(a,b){var c,d;for(c in b)d=b[c],a[c]||(a[c]=d);return a},a=function(){function a(a){var b;b="https:"===document.location.protocol?"https":"http",this.cookieLifespan=365,this.cookieName="myna"+a,this.timeout=400,this.baseurl=""+b+"://api.mynaweb.com",this.loglevel=f.ERROR,this.rewardSuccess=function(a){return void 0},this.error=function(a){return void 0}}return a.prototype.extend=function(a){return h(h({},a),this)},a}(),b={create:function(a,b,c){var d,e;return e=c?(d=new Date,d.setTime(d.getTime()+c*24*60*60*1e3),"; expires="+d.toGMTString()):"",document.cookie=""+a+"="+(b+e)+"; path=/"},read:function(a){var b,c,d,e,f,g,h,i;g=a+"=",f=function(a){var b;return b=a.indexOf(g),b>=0&&a.substring(0,b).match("^\\s*$")},c=function(a){var b;return b=a.indexOf(g),a.substring(b+g.length,a.length)},d=document.cookie.split(";");for(h=0,i=d.length;h<i;h++)b=d[h],f(b)&&(e=c(b));return e},erase:function(a){return b.create(a,"",-1)}},window.Myna.callbacks=[],d={callbackCounter:0,removeCallback:function(a){if(!this.readyState||this.readyState==="complete"||this.readyState==="loaded"){this.onload=null;try{return this.parentNode.removeChild(this)}catch(b){}finally{window.Myna.callbacks[a]=null}}},doJsonP:function(a){var b,c,e,f,g,h,i;f=!1,b="callback"+d.callbackCounter++,window.Myna.callbacks[b]=function(b){if(!f)return f=!0,a.success.apply(this,arguments)},g=a.url+"?",i=a.data;for(e in i)h=i[e],g+=""+e+"="+h+"&";return g+="callback=window.Myna.callbacks."+b,a.timeout>0&&window.setTimeout(function(){if(!f)return f=!0,d.removeCallback.call(c,b),a.error({typename:"problem",subtype:500,messages:[{typename:"timeout",item:"The server took longer than "+a.timeout+" ms to reply"}]})},a.timeout),c=document.createElement("script"),c.setAttribute("type","text/javascript"),c.setAttribute("async","true"),c.onload=c.onreadystatechange=function(){return d.removeCallback.call(c,b)},c.setAttribute("src",g),document.getElementsByTagName("head")[0].appendChild(c)}},c=function(){function c(b,c){this.uuid=b,c==null&&(c={}),this.config=(new a(this.uuid)).extend(c),this.logger=new e(this.config.loglevel)}return c.prototype.suggest=function(a,b){var c,e,i,j,k=this;return b==null&&(b=this.config.error),c=function(a){var b,c,d,e,f;e=Myna.onsuggest,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b(k,a));return f},j=function(b){var d;return k.logger.log(f.DEBUG,"Experiment.suggest successWrapper called"),k.logger.log(f.DEBUG,b),b.typename==="suggestion"?(k.logger.log(f.INFO,"Myna suggested "+b.choice),k.logger.log(f.DEBUG,"Response token is "+b.token),d=new g(k,b.choice,b.token),c(d),a?a(d):k.logger.log(f.WARN,"You should pass a success function to Experiment.suggest. See the docs for details.")):b.typename==="problem"?(k.logger.log(f.ERROR,"Experiment.suggest returned an API error: "+b.subtype+" "+b.messages),e(b)):(k.logger.log(f.ERROR,"Experiment.suggest did something unexpected"),k.logger.log(f.ERROR,b),e({typename:"problem",subtype:400,messages:[{typename:"unexpected",item:b}]}))},e=function(a){k.logger.log(f.ERROR,"Experiment.suggest errorWrapper called"),k.logger.log(f.ERROR,a),c(a);if(b)return b(a)},i={url:this.config.baseurl+("/v1/experiment/"+this.uuid+"/suggest"),data:{},success:j,error:e},d.doJsonP(h(i,this.config))},c.prototype.recall=function(){var a,c,d,e;return c=b.read(this.config.cookieName),c?(d=c.indexOf(":"),d>=0?(e=c.substring(0,d),a=c.substring(d+1,c.length),new g(this,a,e)):void 0):void 0},c.prototype.forget=function(){return b.erase(this.config.cookieName)},c}(),window.Myna.Experiment=c,g=function(){function a(a,b,c){this.experiment=a,this.choice=b,this.token=c}return a.prototype.reward=function(a,b,c){var e,g,i,j,k,l=this;return a==null&&(a=1),b==null&&(b=this.experiment.config.rewardSuccess),c==null&&(c=this.experiment.config.error),g=function(b){var c,d,e,f,g;f=Myna.onreward,g=[];for(d=0,e=f.length;d<e;d++)c=f[d],g.push(c(l,a,b));return g},e={token:this.token,amount:a},k=function(a){return g(a),b(a)},i=function(a){l.experiment.logger.log(f.ERROR,"Suggestion.reward errorWrapper called"),l.experiment.logger.log(f.ERROR,a),g(a);if(c)return c(a)},j={url:this.experiment.config.baseurl+("/v1/experiment/"+this.experiment.uuid+"/reward"),data:e,success:k,error:i},d.doJsonP(h(j,this.experiment.config))},a.prototype.remember=function(){return b.create(this.experiment.config.cookieName,""+this.token+":"+this.choice,this.experiment.config.cookieLifespan)},a.prototype.rewardOnClick=function(a,b,c){var d,e,f=this;return c==null&&(c=1),e=function(){return window.location=b},d=function(a){return a||(a=window.event),a.stopPropagation&&a.stopPropagation(),a.returnValue&&(a.returnValue=!1),f.reward(c,e,e),!1},a.onclick=d},a}(),h(window.Myna,{onload:[],onsuggest:[],onreward:[]}),window.Myna.onload.push=function(){var a,b,c,d,e;a=1<=arguments.length?m.call(arguments,0):[],e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(b());return e},l=window.Myna.onload;for(j=0,k=l.length;j<k;j++)i=l[j],i()}).call(this);