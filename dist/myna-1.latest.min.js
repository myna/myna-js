/*! myna - v1.0.0 - 2012-07-19
* http://mynaweb.com/
* Copyright (c) 2012 Noel Welsh; Licensed BSD 2-Clause */
(function(){var a,b,c,d,e,f,g,h;window.Myna={},f={SILENT:0,ERROR:1,WARN:2,INFO:3,DEBUG:4},e=function(){function a(a){this.loglevel=a}return a.prototype.log=function(a,b){if(window.console&&this.loglevel>=a)return window.console.log(b)},a}(),h=function(a,b){var c,d;for(c in b)d=b[c],a[c]||(a[c]=d);return a},a=function(){function a(a){var b;b="https:"===document.location.protocol?"https":"http",this.cookieLifespan=365,this.cookieName="myna"+a,this.timeout=400,this.baseurl=""+b+"://api.mynaweb.com",this.loglevel=f.ERROR,this.rewardSuccess=function(a){return void 0},this.error=function(a){return void 0}}return a.prototype.extend=function(a){return h(h({},a),this)},a}(),b={create:function(a,b,c){var d,e;return e=c?(d=new Date,d.setTime(d.getTime()+c*24*60*60*1e3),"; expires="+d.toGMTString()):"",document.cookie=""+a+"="+(b+e)+"; path=/"},read:function(a){var b,c,d,e,f,g,h,i;g=a+"=",f=function(a){var b;return b=a.indexOf(g),b>=0&&a.substring(0,b).match("^\\s*$")},c=function(a){var b;return b=a.indexOf(g),a.substring(b+g.length,a.length)},d=document.cookie.split(";");for(h=0,i=d.length;h<i;h++)b=d[h],f(b)&&(e=c(b));return e},erase:function(a){return b.create(a,"",-1)}},window.Myna.callbacks=[],d={callbackCounter:0,removeCallback:function(a){if(!this.readyState||this.readyState==="complete"||this.readyState==="loaded"){this.onload=null;try{return this.parentNode.removeChild(this)}catch(b){}finally{window.Myna.callbacks[a]=null}}},doJsonP:function(a){var b,c,e,f,g,h,i;f=!1,b="callback"+d.callbackCounter++,window.Myna.callbacks[b]=function(b){if(!f)return f=!0,a.success.apply(this,arguments)},g=a.url+"?",i=a.data;for(e in i)h=i[e],g+=""+e+"="+h+"&";return g+="callback=window.Myna.callbacks."+b,a.timeout>0&&window.setTimeout(function(){if(!f)return f=!0,d.removeCallback.call(c,b),a.error({typename:"problem",subtype:500,messages:[{typename:"timeout",item:"The server took longer than "+a.timeout+" ms to reply"}]})},a.timeout),c=document.createElement("script"),c.setAttribute("type","text/javascript"),c.setAttribute("async","true"),c.onload=c.onreadystatechange=function(){return d.removeCallback.call(c,b)},c.setAttribute("src",g),document.getElementsByTagName("head")[0].appendChild(c)}},c=function(){function c(b,c){this.uuid=b,c==null&&(c={}),this.config=(new a(this.uuid)).extend(c),this.logger=new e(this.config.loglevel)}return c.prototype.suggest=function(a,b){var c,e,i,j=this;return b==null&&(b=this.config.error),i=function(c){var d;j.logger.log(f.DEBUG,"Experiment.suggest successWrapper called"),j.logger.log(f.DEBUG,c);if(c.typename==="suggestion")return j.logger.log(f.INFO,"Myna suggested "+c.choice),j.logger.log(f.DEBUG,"Response token is "+c.token),d=new g(j,c.choice,c.token),a?a(d):j.logger.log(f.WARN,"You should pass a success function to Experiment.suggest. See the docs for details.");if(c.typename==="problem"){j.logger.log(f.ERROR,"Experiment.suggest returned an API error: "+c.subtype+" "+c.messages);if(b)return b(c)}else{j.logger.log(f.ERROR,"Experiment.suggest did something unexpected"),j.logger.log(f.ERROR,c);if(b)return b({typename:"problem",subtype:400,messages:[{typename:"unexpected",item:c}]})}},c=function(a){j.logger.log(f.ERROR,"Experiment.suggest errorWrapper called"),j.logger.log(f.ERROR,a);if(b)return b(a)},e={url:this.config.baseurl+("/v1/experiment/"+this.uuid+"/suggest"),data:{},success:i,error:c},d.doJsonP(h(e,this.config))},c.prototype.recall=function(){var a,c,d,e;return c=b.read(this.config.cookieName),c?(d=c.indexOf(":"),d>=0?(e=c.substring(0,d),a=c.substring(d+1,c.length),new g(this,a,e)):void 0):void 0},c.prototype.forget=function(){return b.erase(this.config.cookieName)},c}(),window.Myna.Experiment=c,g=function(){function a(a,b,c){this.experiment=a,this.choice=b,this.token=c}return a.prototype.reward=function(a,b,c){var e,g,i,j=this;return a==null&&(a=1),b==null&&(b=this.experiment.config.rewardSuccess),c==null&&(c=this.experiment.config.error),e={token:this.token,amount:a},g=function(a){j.experiment.logger.log(f.ERROR,"Suggestion.reward errorWrapper called"),j.experiment.logger.log(f.ERROR,a);if(c)return c(a)},i={url:this.experiment.config.baseurl+("/v1/experiment/"+this.experiment.uuid+"/reward"),data:e,success:b,error:g},d.doJsonP(h(i,this.experiment.config))},a.prototype.remember=function(){return b.create(this.experiment.config.cookieName,""+this.token+":"+this.choice,this.experiment.config.cookieLifespan)},a.prototype.rewardOnClick=function(a,b,c){var d,e,f=this;return c==null&&(c=1),e=function(){return window.location=b},d=function(a){return a||(a=window.event),a.stopPropagation&&a.stopPropagation(),a.returnValue&&(a.returnValue=!1),f.reward(c,e,e),!1},a.onclick=d},a}()}).call(this);